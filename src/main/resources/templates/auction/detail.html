<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시글 상세정보</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/detail_.css}">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.18/dist/sweetalert2.all.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+KR|Roboto">


    <script th:src="@{/js/audiplay.js}"></script>



    <script>
        document.addEventListener("DOMContentLoaded", function () {
        const buttons = document.querySelectorAll('.button-container button');
        const commentContent = document.querySelector('.body-comment');
        const authorPostContent = document.querySelector('.body-authorPost');

        const commentButton = document.querySelector('.comment-button');

        // 초기 설정 댓글이 선택되어있도록
        commentContent.style.display = 'block';
        authorPostContent.style.display = 'none';
        commentButton.classList.add('active');

        buttons.forEach(button => {
            button.addEventListener('click', () => {
                buttons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // 댓글 버튼을 클릭했을 때
                if (button.classList.contains('comment-button')) {
                    commentContent.style.display = 'block';
                    authorPostContent.style.display = 'none';
                }
                // Entries 버튼을 클릭했을 때
                else if (button.classList.contains('authorPost-button')) {
                    commentContent.style.display = 'none';
                    authorPostContent.style.display = 'block';
                }
            });
        });
    });

    </script>



</head>
<body>

<div class="container">

    <div class="container-header">
        <div class="title-split-container">
            <div class="title-left-side">
                <img class="title-image" th:src="@{__${musicAuction.albumImage}__}" onError="this.src='/pictures/no_profile.png';" alt="Album Cover">
            </div>

            <div class="title-right-side">
                <div th:text="${genre}">장르</div>
                <h1 class="album-title" th:text="${musicAuction.title}">Album Title</h1>

                <div>
                    <img class="title-profile-image" th:src="@{__${musicAuction.authorNickname.memberImage}__}" onError="this.src='/pictures/no_profile.png';" alt="Album Cover">
                    <span class="title-author" th:text="${musicAuction.authorNickname.nickname}" >Author</span>
                </div>

                <!-- th:src="${audioPath}" 테스트 완료 후 경로 설정 시 -->
                <div class="title-audio">
                    <audio-player th:attr="title='Audio Music',
                    src=${musicAuction.albumMusic},
                    bar-width='3', bar-gap='0.3',
                    preload='preload'"></audio-player>
                </div>

                <script src="/js/audio-player.js"></script>

            </div>
        </div>
    </div>


    <div class="container-body">

        <div class="body-split-container">

            <div class="body-left-side">

                <div class="body-content">
                    <div class="description">Description</div>

                    <div class="content" th:text="${musicAuction.content}"></div>

                </div>
                <hr/>
                <div style="margin-top:30px"> </div>

                <div class="auction-container">
                    <div class="button-container">
                        <button class="comment-button">Comment</button>
                        <button class="authorPost-button">Entries</button>
                    </div>

                    <div class="body-comment">
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <div>작성자 : 내용</div>
                        <form>
                            <input type="hidden" value="글번호" name="글번호">
                            <input type="hidden" value="댓글 작성자" name="댓글 작성자">
                            <textarea rows="4" cols="50" placeholder="댓글 내용을 입력해주세요."></textarea>
                            <input type="submit" value="작성" class="comment-submit-button">
                        </form>
                    </div>

                    <div class="body-authorPost">
                        <div>글번호 , ~~~~~~~~~~~~~~~~~~~~~</div>
                        <div>글번호 , ~~~~~~~~~~~~~~~~~~~~~</div>
                        <div>글번호 , ~~~~~~~~~~~~~~~~~~~~~</div>
                        <div>글번호 , ~~~~~~~~~~~~~~~~~~~~~</div>
                    </div>

                </div>

            </div>

        <div class="body-right-side">
            <div class="bidding-box">
                <div th:if="${remainingTime != null}">
                    <div class="deadline-text">Submission Deadline</div>
                    <div class="deadline" id="timeDifference"></div>
                </div>

                <div th:if="${remainingTime == null}">
                    <div class="deadline-end">해당 경매는 종료되었습니다.</div>
                </div>

                <div th:if="${maxBiddingPrice != 0}">
                    <div>Top Price</div>
                    <div class="money" data-th-text="${#numbers.formatInteger(maxBiddingPrice, 0, 'COMMA') + ' ₩'}"></div>
                </div>

                <div th:unless="${maxBiddingPrice != 0}">
                    <div>경매 시작가<br>(경매 내역이 없습니다)</div>
                    <div class="money" th:text="${#numbers.formatInteger(musicAuction.startingBid, 0, 'COMMA') + ' ₩'}"></div>
                </div>

                <div class="bidding">

                    <div class="bidding-addPrice">

                        <span class="bidding-button">
                            <span class="left-align-button">
                                <button th:attr="onclick='addPrice(' + ${addValue1} + ') '" data-th-text="|+${addValue1}|"></button>
                            </span>
                            <span class="center-align-button">
                                <button th:attr="onclick='addPrice(' + ${addValue2} + ') '" data-th-text="|+${addValue2}|"></button>
                            </span>
                            <span class="right-align-button">
                                <button th:attr="onclick='addPrice(' + ${addValue3} + ') '" data-th-text="|+${addValue3}|"></button>
                            </span>
                        </span>

                    </div>

                    <form id="biddingForm" action="" method="post">
                        <div>
                            <input type="hidden" name="startPrice" th:value="${musicAuction.startingBid}"/>
                            <input type="hidden" name="auctionId" th:value="${musicAuction.id}"/>
                            <input type="hidden" name="bidder" th:value="|qwert|"/>
                            <input type="number" id="bidding_price" name="bidding_price" th:value="${maxBiddingPrice}"/>

                        </div>

                        <div>
                            <input type="submit" value="입찰하기"/>
                        </div>

                    </form>
                </div>
            </div>

        </div>

        </div>
    </div>

</div>



<script>
    $("#biddingForm").submit(function (event) {
        event.preventDefault();

        var biddingPrice = $("#bidding_price").val();

        if (biddingPrice <= 0) {
            Swal.fire({
                icon: 'error',
                title: '유효하지 않은 입찰 가격입니다.',
                text: '입찰 가격을 확인해주세요.'
            });
        } else {
            var formData = $("#biddingForm").serialize();
            $.post("/bid/create", formData)
                .done(function (response) {
                if(response === "Success"){
                    Swal.fire({
                        icon: 'success',
                        title: '입찰 성공',
                        text: biddingPrice + '원에 입찰되었습니다.'
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                            icon: 'error',
                            title: '입찰 실패',
                            text: response
                        });
                }
                })
                .fail(function (xhr, status, error) {
                    var errorMessage = xhr.responseText;
                    Swal.fire({
                        icon: 'error',
                        title: '입찰 실패',
                        text: errorMessage // 에러메시지를 출력함
                    });
                });
        }
    });
</script>




<script>
    function addPrice(amount) {
        // 현재 input 태그의 값을 가져옴
        var inputElement = document.getElementById("bidding_price");
        var currentValue = parseInt(inputElement.value);

        // 버튼에 해당하는 금액을 더해서 input 태그의 값을 업데이트
        var newValue = currentValue + amount;
        inputElement.value = newValue;
    }
</script>



<script th:inline="javascript">
    /*<![CDATA[*/
    var initialTimeDifference = /*[[${remainingTime}]]*/;
    var timeDifference = initialTimeDifference;

    function updateTimeDifference() {
        var timeDifferenceElement = document.getElementById("timeDifference");

        var days = Math.floor(timeDifference / (60 * 60 * 24));
        var hours = Math.floor((timeDifference % (60 * 60 * 24)) / (60 * 60));
        var minutes = Math.floor((timeDifference % (60 * 60)) / 60);
        var seconds = timeDifference % 60;

        var timeString = days + "일 " + hours + "시간 " + minutes + "분 " + seconds + "초";
        timeDifferenceElement.textContent = timeString;

        timeDifference--; // 시간 차이를 1초씩 감소
        if (timeDifference == -2){      // 남은 시간이 음수가 되면 경매는 종료 (0, -1 로설정하니 오차 때문에 잘못작동할때가 있음)
            window.location.reload();
        }
    }

    updateTimeDifference();
    setInterval(updateTimeDifference, 1000);
    /*]]>*/
</script>



</body>
</html>
